<!-- 
    Jinja2 Template File
    This file contains Jinja2 template syntax that will be processed server-side.
    IDE warnings about template syntax are expected and can be ignored.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.jsdelivr.net/npm/graphology@0.26.0/dist/graphology.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sigma@2.4.0/build/sigma.min.js"></script>
    <!-- ForceAtlas2 layout from graphology-library -->
    <script src="https://cdn.jsdelivr.net/npm/graphology-library/dist/graphology-library.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: {{ background_color|default('#0a0e27') }};
            color: #e0e0e0;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: {{ graph_background|default('linear-gradient(135deg, #0a0e27 0%, #1a1e3f 100%)') }};
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(26, 30, 63, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 320px;
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }

        #controls h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #6c8eff;
            font-weight: 600;
        }

        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(26, 30, 63, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        #stats h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #6c8eff;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .stat-label {
            color: #a0a0a0;
        }

        .stat-value {
            color: #ffffff;
            font-weight: 600;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #a0a0a0;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #6c8eff;
            background: rgba(255, 255, 255, 0.08);
        }

        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(135deg, #6c8eff 0%, #5a7de8 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 142, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        button.secondary:hover {
            box-shadow: 0 4px 12px rgba(74, 85, 104, 0.4);
        }

        input[type="range"] {
            width: 100%;
            margin: 8px 0;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6c8eff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #5a7de8;
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6c8eff;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: #5a7de8;
            transform: scale(1.2);
        }

        .slider-value {
            float: right;
            color: #6c8eff;
            font-weight: 600;
            font-size: 12px;
        }

        .physics-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .physics-controls h3 {
            font-size: 14px;
            color: #6c8eff;
            margin-bottom: 12px;
        }

        button.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        button.danger:hover {
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        button.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        button.success:hover {
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
        }

        #node-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 30, 63, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 350px;
            display: none;
            z-index: 1000;
        }

        #node-info h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #6c8eff;
            word-break: break-all;
        }

        #node-info p {
            margin: 6px 0;
            font-size: 13px;
            color: #a0a0a0;
        }

        #node-info strong {
            color: #ffffff;
        }

        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 30, 63, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        #legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #6c8eff;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 2000;
            display: none;
            max-width: 250px;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #tooltip.visible {
            display: block;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #6c8eff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="container">
        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Applying layout...</p>
        </div>

        <div id="controls">
            <h2>üîç Network Controls</h2>
            <div class="control-group">
                <label for="search">Search User:</label>
                <input type="text" id="search" placeholder="Enter username...">
            </div>
            <button onclick="highlightNode()">Highlight User</button>
            <button onclick="resetView()" class="secondary">Reset View</button>
            <button onclick="startLayout()" class="success" id="startLayoutBtn">‚ñ∂ Start Physics</button>
            <button onclick="stopLayout()" class="danger" id="stopLayoutBtn" style="display:none;">‚è∏ Stop Physics</button>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showLabels" checked onchange="toggleLabels()" style="width: auto; margin-right: 8px;">
                    Show Node Labels
                </label>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showTooltips" checked onchange="toggleTooltips()" style="width: auto; margin-right: 8px;">
                    Show Tooltips on Hover
                </label>
            </div>
            
            <div class="physics-controls">
                <h3>‚öôÔ∏è Physics Settings</h3>
                
                <div class="control-group">
                    <label for="gravity">
                        Gravity: <span class="slider-value" id="gravityValue">1.0</span>
                    </label>
                    <input type="range" id="gravity" min="0.1" max="5" step="0.1" value="1.0" oninput="updatePhysics()">
                </div>
                
                <div class="control-group">
                    <label for="scalingRatio">
                        Scaling: <span class="slider-value" id="scalingValue">10</span>
                    </label>
                    <input type="range" id="scalingRatio" min="1" max="50" step="1" value="10" oninput="updatePhysics()">
                </div>
                
                <div class="control-group">
                    <label for="edgeWeightInfluence">
                        Edge Weight: <span class="slider-value" id="edgeWeightValue">1.0</span>
                    </label>
                    <input type="range" id="edgeWeightInfluence" min="0" max="2" step="0.1" value="1.0" oninput="updatePhysics()">
                </div>
                
                <div class="control-group">
                    <label for="slowDown">
                        Slow Down: <span class="slider-value" id="slowDownValue">5.0</span>
                    </label>
                    <input type="range" id="slowDown" min="0.1" max="10" step="0.1" value="5.0" oninput="updatePhysics()">
                </div>
                
                <div class="control-group">
                    <label for="strongGravityMode">
                        <input type="checkbox" id="strongGravityMode" onchange="updatePhysics()" style="width: auto; margin-right: 8px;">
                        Strong Gravity Mode
                    </label>
                </div>
                
                <div class="control-group">
                    <label for="linLogMode">
                        <input type="checkbox" id="linLogMode" onchange="updatePhysics()" style="width: auto; margin-right: 8px;">
                        LinLog Mode
                    </label>
                </div>
                
                <div class="control-group">
                    <label for="outboundAttractionDistribution">
                        <input type="checkbox" id="outboundAttractionDistribution" onchange="updatePhysics()" style="width: auto; margin-right: 8px;">
                        Outbound Attraction
                    </label>
                </div>
                
                <div class="control-group">
                    <label for="adjustSizes">
                        <input type="checkbox" id="adjustSizes" onchange="updatePhysics()" style="width: auto; margin-right: 8px;">
                        Adjust Sizes (Prevent Overlap)
                    </label>
                </div>
                
                <div class="control-group">
                    <label for="barnesHutOptimize">
                        <input type="checkbox" id="barnesHutOptimize" checked onchange="updatePhysics()" style="width: auto; margin-right: 8px;">
                        Barnes-Hut Optimize
                    </label>
                </div>
                
                <div class="control-group">
                    <label for="barnesHutTheta">
                        Barnes-Hut Œ∏: <span class="slider-value" id="barnesHutThetaValue">0.5</span>
                    </label>
                    <input type="range" id="barnesHutTheta" min="0.1" max="1.5" step="0.1" value="0.5" oninput="updatePhysics()">
                </div>
            </div>
            
            <button onclick="exportView()" class="secondary">Export View</button>
        </div>

        <div id="stats">
            <h3>üìä Network Stats</h3>
            <div class="stat-item">
                <span class="stat-label">Nodes:</span>
                <span class="stat-value" id="node-count">{{ node_count|default(0) }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Edges:</span>
                <span class="stat-value" id="edge-count">{{ edge_count|default(0) }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Avg Degree:</span>
                <span class="stat-value" id="avg-degree">{{ avg_degree|default('0.00') }}</span>
            </div>
            {% if density %}
            <div class="stat-item">
                <span class="stat-label">Density:</span>
                <span class="stat-value">{{ "%.4f"|format(density) }}</span>
            </div>
            {% endif %}
        </div>

        <div id="node-info">
            <h3 id="node-name"></h3>
            <p><strong>Followers:</strong> <span id="node-followers">0</span></p>
            <p><strong>Following:</strong> <span id="node-following">0</span></p>
            <p><strong>Connections:</strong> <span id="node-degree">0</span></p>
            {% if show_centrality %}
            <p><strong>Centrality:</strong> <span id="node-centrality">0</span></p>
            {% endif %}
            {% if show_community %}
            <p><strong>Community:</strong> <span id="node-community">-</span></p>
            {% endif %}
        </div>

        <div id="legend">
            <h4>Node Colors</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b9d;"></div>
                <span>Popular (more followers)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ecdc4;"></div>
                <span>Active (more following)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6c8eff;"></div>
                <span>Balanced</span>
            </div>
        </div>

        <div id="tooltip"></div>
    </div>

    <script>
        // Graph data from Jinja2 template
        const graphData = {{ graph_data|tojson }};
        const config = {{ config|tojson }};
        
        let graph, renderer, layoutRunning = false, layoutWorker = null;
        
        // Track previous state of labels/tooltips before physics
        let labelsBeforePhysics = true;
        let tooltipsBeforePhysics = true;
        
        // Physics settings - ForceAtlas2 parameters
        let physicsSettings = {
            gravity: 1.0,
            scalingRatio: 10,
            edgeWeightInfluence: 1.0,
            slowDown: 5.0,
            linLogMode: false,
            outboundAttractionDistribution: false,
            adjustSizes: false,
            barnesHutOptimize: true,
            barnesHutTheta: 0.5,
            strongGravityMode: false
        };
        
        // Separate setting for overlap prevention (not a ForceAtlas2 param)
        let preventOverlap = false;

        function initGraph() {
            // Initialize Graphology graph
            graph = new graphology.DirectedGraph();

            // Add nodes
            graphData.nodes.forEach(node => {
                graph.addNode(node.key, node.attributes);
            });

            // Add edges
            graphData.edges.forEach(edge => {
                try {
                    if (!graph.hasEdge(edge.source, edge.target)) {
                        graph.addEdge(edge.source, edge.target, edge.attributes || {});
                    }
                } catch (e) {
                    console.warn('Failed to add edge:', edge, e);
                }
            });

            return graph;
        }

        function initRenderer() {
            const container = document.getElementById('container');
            
            renderer = new Sigma(graph, container, {
                renderEdgeLabels: config.renderEdgeLabels || false,
                renderLabels: config.show_labels !== false,
                defaultNodeColor: config.defaultNodeColor || '#6c8eff',
                defaultEdgeColor: config.defaultEdgeColor || 'rgba(108, 142, 255, 0.2)',
                labelSize: config.labelSize || 12,
                labelColor: { color: config.labelColor || '#ffffff' },
                labelWeight: config.labelWeight || '600',
                minCameraRatio: config.minCameraRatio || 0.1,
                maxCameraRatio: config.maxCameraRatio || 10,
                enableEdgeEvents: true
            });

            // Add click event
            renderer.on('clickNode', ({ node }) => {
                showNodeInfo(node);
            });

            // Add hover events
            renderer.on('enterNode', ({ node }) => {
                if (config.show_tooltips !== false) {
                    showTooltip(node);
                }
                const nodeAttributes = graph.getNodeAttributes(node);
                if (!nodeAttributes.originalSize) {
                    graph.setNodeAttribute(node, 'originalSize', nodeAttributes.size);
                }
                graph.setNodeAttribute(node, 'size', nodeAttributes.originalSize * 1.5);
                renderer.refresh();
            });

            renderer.on('leaveNode', ({ node }) => {
                if (config.show_tooltips !== false) {
                    hideTooltip();
                }
                const nodeAttributes = graph.getNodeAttributes(node);
                if (nodeAttributes.originalSize) {
                    graph.setNodeAttribute(node, 'size', nodeAttributes.originalSize);
                }
                renderer.refresh();
            });

            // Mouse move for tooltip positioning
            renderer.getMouseCaptor().on('mousemove', (e) => {
                const tooltip = document.getElementById('tooltip');
                if (tooltip.classList.contains('visible')) {
                    tooltip.style.left = (e.x + 15) + 'px';
                    tooltip.style.top = (e.y + 15) + 'px';
                }
            });

            renderer.refresh();
        }

        function showNodeInfo(nodeId) {
            const attributes = graph.getNodeAttributes(nodeId);
            document.getElementById('node-name').textContent = attributes.label || nodeId;
            document.getElementById('node-followers').textContent = attributes.followers || 0;
            document.getElementById('node-following').textContent = attributes.following || 0;
            document.getElementById('node-degree').textContent = graph.degree(nodeId);
            
            {% if show_centrality %}
            const centralityElem = document.getElementById('node-centrality');
            if (centralityElem && attributes.centrality !== undefined) {
                centralityElem.textContent = attributes.centrality.toFixed(4);
            }
            {% endif %}
            
            {% if show_community %}
            const communityElem = document.getElementById('node-community');
            if (communityElem && attributes.community !== undefined) {
                communityElem.textContent = attributes.community;
            }
            {% endif %}
            
            document.getElementById('node-info').style.display = 'block';
        }

        function showTooltip(nodeId) {
            const attributes = graph.getNodeAttributes(nodeId);
            const tooltip = document.getElementById('tooltip');
            
            let content = `<strong>${attributes.label || nodeId}</strong><br>`;
            content += `Followers: ${attributes.followers || 0}<br>`;
            content += `Following: ${attributes.following || 0}<br>`;
            content += `Degree: ${graph.degree(nodeId)}`;
            
            {% if show_centrality %}
            if (attributes.centrality !== undefined) {
                content += `<br>Centrality: ${attributes.centrality.toFixed(4)}`;
            }
            {% endif %}
            
            {% if show_community %}
            if (attributes.community !== undefined) {
                content += `<br>Community: ${attributes.community}`;
            }
            {% endif %}
            
            tooltip.innerHTML = content;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        function highlightNode() {
            const searchTerm = document.getElementById('search').value.toLowerCase().trim();
            if (!searchTerm) {
                alert('Please enter a username to search');
                return;
            }

            let found = false;
            graph.forEachNode((node, attributes) => {
                const label = (attributes.label || node).toLowerCase();
                if (label.includes(searchTerm)) {
                    // Store original color if not already stored
                    if (!attributes.originalColor) {
                        graph.setNodeAttribute(node, 'originalColor', attributes.color);
                    }
                    if (!attributes.originalSize) {
                        graph.setNodeAttribute(node, 'originalSize', attributes.size);
                    }
                    
                    // Highlight the node
                    graph.setNodeAttribute(node, 'color', '#ffff00');
                    graph.setNodeAttribute(node, 'size', attributes.originalSize * 2);
                    
                    // Center camera on node
                    const nodePosition = renderer.getNodeDisplayData(node);
                    if (nodePosition) {
                        renderer.getCamera().animate(nodePosition, {
                            duration: 500
                        });
                    }
                    
                    showNodeInfo(node);
                    found = true;
                    return false; // Stop iteration
                }
            });

            if (!found) {
                alert('User not found!');
            } else {
                renderer.refresh();
            }
        }

        function resetView() {
            // Reset all node colors and sizes
            graph.forEachNode((node, attributes) => {
                if (attributes.originalColor) {
                    graph.setNodeAttribute(node, 'color', attributes.originalColor);
                }
                if (attributes.originalSize) {
                    graph.setNodeAttribute(node, 'size', attributes.originalSize);
                }
            });

            renderer.getCamera().animate({ x: 0.5, y: 0.5, ratio: 1 }, { duration: 500 });
            document.getElementById('node-info').style.display = 'none';
            document.getElementById('search').value = '';
            renderer.refresh();
        }

        function toggleLabels() {
            const showLabels = document.getElementById('showLabels').checked;
            renderer.setSetting('renderLabels', showLabels);
            renderer.refresh();
            console.log('Labels:', showLabels ? 'enabled' : 'disabled');
        }

        function toggleTooltips() {
            const showTooltips = document.getElementById('showTooltips').checked;
            config.show_tooltips = showTooltips;
            console.log('Tooltips:', showTooltips ? 'enabled' : 'disabled');
        }

        function updatePhysics() {
            // Update physics settings from sliders and checkboxes
            physicsSettings.gravity = parseFloat(document.getElementById('gravity').value);
            physicsSettings.scalingRatio = parseFloat(document.getElementById('scalingRatio').value);
            physicsSettings.edgeWeightInfluence = parseFloat(document.getElementById('edgeWeightInfluence').value);
            physicsSettings.slowDown = parseFloat(document.getElementById('slowDown').value);
            physicsSettings.barnesHutTheta = parseFloat(document.getElementById('barnesHutTheta').value);
            physicsSettings.strongGravityMode = document.getElementById('strongGravityMode').checked;
            physicsSettings.linLogMode = document.getElementById('linLogMode').checked;
            physicsSettings.outboundAttractionDistribution = document.getElementById('outboundAttractionDistribution').checked;
            physicsSettings.adjustSizes = document.getElementById('adjustSizes').checked;
            physicsSettings.barnesHutOptimize = document.getElementById('barnesHutOptimize').checked;
            
            // Update display values
            document.getElementById('gravityValue').textContent = physicsSettings.gravity.toFixed(1);
            document.getElementById('scalingValue').textContent = physicsSettings.scalingRatio.toFixed(0);
            document.getElementById('edgeWeightValue').textContent = physicsSettings.edgeWeightInfluence.toFixed(1);
            document.getElementById('slowDownValue').textContent = physicsSettings.slowDown.toFixed(1);
            document.getElementById('barnesHutThetaValue').textContent = physicsSettings.barnesHutTheta.toFixed(1);
            
            // Settings will be applied on next animation frame if layout is running
            console.log('Physics settings updated:', physicsSettings);
        }

        function startLayout() {
            if (layoutRunning) {
                console.log('Layout is already running');
                return;
            }

            // Save current state of labels and tooltips
            labelsBeforePhysics = document.getElementById('showLabels').checked;
            tooltipsBeforePhysics = document.getElementById('showTooltips').checked;
            
            // Disable labels and tooltips for better performance
            if (labelsBeforePhysics) {
                document.getElementById('showLabels').checked = false;
                toggleLabels();
            }
            if (tooltipsBeforePhysics) {
                document.getElementById('showTooltips').checked = false;
                toggleTooltips();
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('startLayoutBtn').style.display = 'none';
            document.getElementById('stopLayoutBtn').style.display = 'block';
            layoutRunning = true;

            try {
                // Use graphology-library ForceAtlas2
                if (!window.graphologyLibrary || !window.graphologyLibrary.layoutForceAtlas2) {
                    throw new Error('graphology-library not loaded');
                }
                
                console.log('Using ForceAtlas2 from graphology-library');
                
                // Infer base settings from graph structure
                const inferredSettings = window.graphologyLibrary.layoutForceAtlas2.inferSettings(graph);
                
                // Run layout with animation
                let iteration = 0;
                const maxIterations = 500;
                
                const animate = () => {
                    if (!layoutRunning || iteration >= maxIterations) {
                        stopLayout();
                        return;
                    }
                    
                    // Merge inferred settings with current user settings (allows live updates)
                    const currentSettings = Object.assign({}, inferredSettings, physicsSettings);
                    
                    // Run one iteration and assign positions to graph
                    window.graphologyLibrary.layoutForceAtlas2.assign(graph, {
                        iterations: 1,
                        settings: currentSettings
                    });
                    
                    iteration++;
                    
                    // Refresh renderer every 3 iterations for smooth performance
                    if (iteration % 3 === 0) {
                        renderer.refresh();
                    }
                    
                    // Continue animation
                    requestAnimationFrame(animate);
                };
                
                animate();
                console.log('ForceAtlas2 layout started');
            } catch (e) {
                console.error('Layout error:', e);
                alert('Failed to start layout: ' + e.message);
                stopLayout();
            }
        }

        function stopLayout() {
            layoutRunning = false;
            layoutWorker = null;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('startLayoutBtn').style.display = 'block';
            document.getElementById('stopLayoutBtn').style.display = 'none';
            
            // Restore previous state of labels and tooltips
            if (labelsBeforePhysics) {
                document.getElementById('showLabels').checked = true;
                toggleLabels();
            }
            if (tooltipsBeforePhysics) {
                document.getElementById('showTooltips').checked = true;
                toggleTooltips();
            }
            
            renderer.refresh();
            console.log('Layout stopped');
        }

        function exportView() {
            // Get current camera state
            const camera = renderer.getCamera();
            const state = camera.getState();
            
            const exportData = {
                camera: state,
                timestamp: new Date().toISOString(),
                stats: {
                    nodes: graph.order,
                    edges: graph.size
                }
            };
            
            console.log('Current view state:', exportData);
            alert('View state exported to console. Check browser developer tools.');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initGraph();
                initRenderer();
                
                // Set checkbox states based on config
                document.getElementById('showLabels').checked = config.show_labels !== false;
                document.getElementById('showTooltips').checked = config.show_tooltips !== false;
                
                console.log('Sigma.js visualization initialized');
                console.log('Nodes:', graph.order);
                console.log('Edges:', graph.size);
                
                // Check if graphology-library is available
                if (window.graphologyLibrary && window.graphologyLibrary.layoutForceAtlas2) {
                    console.log('‚úì graphology-library loaded with ForceAtlas2');
                } else {
                    console.error('‚úó graphology-library failed to load');
                }
            } catch (e) {
                console.error('Initialization error:', e);
                alert('Failed to initialize visualization: ' + e.message);
            }
        });

        // Keyboard shortcuts
        document.getElementById('search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                highlightNode();
            }
        });

        // Prevent context menu on container
        document.getElementById('container').addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>

