name: Documentation

on:
  # Only triggered by CI workflow after smoke test passes
  workflow_call:
    inputs:
      prebuild-cache-key:
        description: 'Cache key from CI prebuild'
        required: true
        type: string

jobs:
  # Job 1: Documentation Structure (CRITICAL - Pipeline fails if this fails)
  documentation-structure:
    name: Documentation Structure
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Restore CI prebuild cache
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.cache/pip
          FollowWeb/.venv
          FollowWeb/tests/test_data
          .pytest_cache
          .mypy_cache
          .ruff_cache
        key: ${{ inputs.prebuild-cache-key }}
        restore-keys: |
          prebuild-${{ runner.os }}-py3.12-
    
    - name: Install dependencies
      run: |
        # Use cached environment if available
        if [ -d "FollowWeb/.venv" ]; then
          echo "Using prebuild cache"
          cd FollowWeb && source .venv/bin/activate && cd ..
        else
          echo "Installing dependencies fresh"
          python -m pip install --upgrade pip
          python -m pip install -r FollowWeb/requirements.txt
          python -m pip install -r FollowWeb/requirements-test.txt
        fi
        python .github/scripts/ci_helpers.py success "Dependencies installed successfully" --summary-only
    
    - name: Validate documentation structure
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py info "**Documentation Structure Check**" --summary-only
        python ../.github/scripts/ci_helpers.py info "Checking for required documentation files..." --summary-only
        
        # Check for required documentation files
        if [ -f "README.md" ]; then
          python ../.github/scripts/ci_helpers.py success "README.md exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py error "README.md missing" --summary-only
        fi
        
        if [ -f "docs/USER_GUIDE.md" ]; then
          python ../.github/scripts/ci_helpers.py success "docs/USER_GUIDE.md exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py error "docs/USER_GUIDE.md missing" --summary-only
        fi
        
        if [ -f "docs/CONFIGURATION_GUIDE.md" ]; then
          python ../.github/scripts/ci_helpers.py success "docs/CONFIGURATION_GUIDE.md exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py error "docs/CONFIGURATION_GUIDE.md missing" --summary-only
        fi
        
        # Check additional documentation files
        if [ -f "INSTALL_GUIDE.md" ]; then
          python ../.github/scripts/ci_helpers.py success "INSTALL_GUIDE.md exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "INSTALL_GUIDE.md missing (recommended)" --summary-only
        fi
        
        if [ -f "CHANGELOG.md" ]; then
          python ../.github/scripts/ci_helpers.py success "CHANGELOG.md exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "CHANGELOG.md missing (recommended)" --summary-only
        fi
        
        if [ -d "docs/development" ]; then
          python ../.github/scripts/ci_helpers.py success "docs/development/ directory exists" --summary-only
        else
          python ../.github/scripts/ci_helpers.py info "docs/development/ directory not found" --summary-only
        fi
        
        # Validate documentation structure completeness
        required_files=("README.md" "docs/USER_GUIDE.md" "docs/CONFIGURATION_GUIDE.md")
        missing_count=0
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_count=$((missing_count + 1))
          fi
        done
        
        if [ $missing_count -eq 0 ]; then
          python ../.github/scripts/ci_helpers.py success "All required documentation files present" --summary-only
        else
          python ../.github/scripts/ci_helpers.py error "$missing_count required documentation files missing" --summary-only
          exit 1
        fi
    
    - name: Validate documentation content
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py info "**Documentation Content Validation**" --summary-only
        
        # Check if README has proper markdown structure
        if grep -q "^# \|^## " README.md; then
          python ../.github/scripts/ci_helpers.py success "README.md has proper markdown headers" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "README.md might need better markdown structure" --summary-only
        fi
        
        # Check for code examples in documentation
        if grep -q "\`\`\`" README.md docs/USER_GUIDE.md 2>/dev/null; then
          python ../.github/scripts/ci_helpers.py success "Documentation includes code examples" --summary-only
        else
          python ../.github/scripts/ci_helpers.py info "Consider adding code examples to documentation" --summary-only
        fi
        
        # Check for links in documentation
        if grep -q "http\|\.md\|\.py" README.md; then
          python ../.github/scripts/ci_helpers.py success "README.md contains helpful links" --summary-only
        else
          python ../.github/scripts/ci_helpers.py info "README.md could benefit from more links" --summary-only
        fi
        
        # Validate configuration guide has JSON examples
        if [ -f "docs/CONFIGURATION_GUIDE.md" ] && grep -q "json\|JSON\|\`\`\`" docs/CONFIGURATION_GUIDE.md; then
          python ../.github/scripts/ci_helpers.py success "Configuration guide includes examples" --summary-only
        else
          python ../.github/scripts/ci_helpers.py info "Configuration guide could use more examples" --summary-only
        fi
        
        # Check for package metadata consistency
        if grep -q "FollowWeb\|followweb" README.md && grep -q "FollowWeb\|followweb" pyproject.toml; then
          python ../.github/scripts/ci_helpers.py success "Package name consistent across documentation" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "Package name might be inconsistent in documentation" --summary-only
        fi
        
        # Check for broken internal file references
        python ../.github/scripts/ci_helpers.py info "**Internal Link Validation:**" --summary-only
        broken_links=0
        
        # Check for references to files that might not exist
        for doc_file in README.md docs/*.md; do
          if [ -f "$doc_file" ]; then
            # Look for markdown links to local files
            grep -o '\[.*\]([^)]*\.md\|[^)]*\.py\|[^)]*\.json)' "$doc_file" 2>/dev/null | while read -r link; do
              # Extract the file path from the link
              file_path=$(echo "$link" | sed 's/.*(\([^)]*\)).*/\1/')
              if [ ! -f "$file_path" ] && [ ! -d "$file_path" ]; then
                echo "Potential broken link in $doc_file: $file_path" >> broken_links.txt
              fi
            done || true
          fi
        done
        
        if [ -f "broken_links.txt" ] && [ -s "broken_links.txt" ]; then
          link_count=$(wc -l < broken_links.txt)
          python ../.github/scripts/ci_helpers.py warning "Found $link_count potential broken internal links" --summary-only
          python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
          cat broken_links.txt >> $GITHUB_STEP_SUMMARY || true
          python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
        else
          python ../.github/scripts/ci_helpers.py success "No broken internal links detected" --summary-only
        fi
    
    - name: Check documentation quality
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py info "**Documentation Quality Assessment**" --summary-only
        
        # Check for TODO/FIXME comments
        python ../.github/scripts/ci_helpers.py info "**Code Maintenance Comments:**" --summary-only
        if grep -r "TODO\|FIXME" FollowWeb_Visualizor/ > todo_comments.txt 2>/dev/null; then
          comment_count=$(wc -l < todo_comments.txt)
          python ../.github/scripts/ci_helpers.py warning "Found $comment_count TODO/FIXME comments in code" --summary-only
          python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
          head -20 todo_comments.txt >> $GITHUB_STEP_SUMMARY || true
          if [ $comment_count -gt 20 ]; then
            echo "... and $(($comment_count - 20)) more" >> $GITHUB_STEP_SUMMARY
          fi
          python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
        else
          python ../.github/scripts/ci_helpers.py success "No TODO/FIXME comments found in code" --summary-only
        fi
        
        # Check README quality
        python ../.github/scripts/ci_helpers.py info "**README.md Quality Check:**" --summary-only
        readme_lines=$(wc -l < README.md)
        if [ $readme_lines -gt 50 ]; then
          python ../.github/scripts/ci_helpers.py success "README.md is comprehensive ($readme_lines lines)" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "README.md might need more detail ($readme_lines lines)" --summary-only
        fi
        
        # Check for essential README sections
        if grep -q "## Installation\|## Getting Started\|## Usage" README.md; then
          python ../.github/scripts/ci_helpers.py success "README.md contains essential sections" --summary-only
        else
          python ../.github/scripts/ci_helpers.py warning "README.md missing some essential sections (Installation, Usage, etc.)" --summary-only
        fi
        
        # Check documentation file sizes
        python ../.github/scripts/ci_helpers.py info "**Documentation File Analysis:**" --summary-only
        for doc_file in docs/USER_GUIDE.md docs/CONFIGURATION_GUIDE.md; do
          if [ -f "$doc_file" ]; then
            doc_lines=$(wc -l < "$doc_file")
            doc_name=$(basename "$doc_file")
            if [ $doc_lines -gt 30 ]; then
              python ../.github/scripts/ci_helpers.py success "$doc_name is detailed ($doc_lines lines)" --summary-only
            else
              python ../.github/scripts/ci_helpers.py info "$doc_name has $doc_lines lines" --summary-only
            fi
          fi
        done
    
    - name: Upload documentation structure reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation-structure-reports
        path: |
          FollowWeb/todo_comments.txt
          FollowWeb/broken_links.txt
        retention-days: 30
    
    - name: Generate documentation structure summary
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py completion "**DOCUMENTATION STRUCTURE CHECK COMPLETED!**" --summary-only
        python ../.github/scripts/ci_helpers.py info "**Documentation Structure Validation:**" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **Required Files** (All essential documentation present)" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **README Quality** (Comprehensive user documentation)" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **User Guides** (Installation and configuration guides)" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **Code Maintenance** (TODO/FIXME comment analysis)" --summary-only
        python ../.github/scripts/ci_helpers.py info "**Critical documentation files validated successfully**"
  
  # Job 2: Docstring Coverage (CRITICAL - Pipeline fails if this fails)
  docstring-coverage:
    name: Docstring Coverage
    runs-on: ubuntu-latest
    needs: documentation-structure
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Restore CI prebuild cache
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.cache/pip
          FollowWeb/.venv
          FollowWeb/tests/test_data
          .pytest_cache
          .mypy_cache
          .ruff_cache
        key: ${{ inputs.prebuild-cache-key }}
        restore-keys: |
          prebuild-${{ runner.os }}-py3.12-
    
    - name: Install dependencies
      run: |
        # Use cached environment if available
        if [ -d "FollowWeb/.venv" ]; then
          echo "Using CI prebuild cache"
          cd FollowWeb && source .venv/bin/activate && cd ..
        else
          echo "Installing dependencies fresh"
          python -m pip install --upgrade pip
          python -m pip install interrogate
        fi
        python .github/scripts/ci_helpers.py success "Dependencies installed successfully" --summary-only
    
    - name: Check docstring coverage
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py info "**Docstring Coverage Analysis**" --summary-only
        python ../.github/scripts/ci_helpers.py info "Analyzing docstring coverage across all modules..." --summary-only
        
        # Run interrogate with detailed output
        if interrogate -v FollowWeb_Visualizor/ --fail-under=50 2>&1 | tee interrogate_output.txt; then
          python ../.github/scripts/ci_helpers.py success "Docstring coverage meets minimum threshold (50%)" --summary-only
        else
          python ../.github/scripts/ci_helpers.py error "Docstring coverage below threshold - documentation required" --summary-only
          exit 1
        fi
        
        # Add detailed results to summary
        python ../.github/scripts/ci_helpers.py info "**Detailed Coverage Results:**" --summary-only
        python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
        cat interrogate_output.txt >> $GITHUB_STEP_SUMMARY || true
        python ../.github/scripts/ci_helpers.py info "\`\`\`" --summary-only
    
    - name: Upload docstring coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docstring-coverage-reports
        path: |
          FollowWeb/interrogate_output.txt
        retention-days: 30
    
    - name: Generate docstring coverage summary
      working-directory: FollowWeb
      run: |
        python ../.github/scripts/ci_helpers.py completion "**DOCSTRING COVERAGE CHECK COMPLETED!**" --summary-only
        python ../.github/scripts/ci_helpers.py info "**Code Documentation Quality:**" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **Docstring Coverage** (Meets minimum 50% threshold)" --summary-only
        python ../.github/scripts/ci_helpers.py success "- **Module Documentation** (All modules analyzed)" --summary-only
        python ../.github/scripts/ci_helpers.py info "**Code documentation standards validated successfully**"
  
  # Job 3: Conventional Commits (NON-CRITICAL - Pipeline passes even if this fails)
  conventional-commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    needs: docstring-coverage
    continue-on-error: true  # This job won't fail the pipeline
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for commit validation
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Validate PR title follows conventional commits
      if: github.event_name == 'pull_request'
      uses: amannn/action-semantic-pull-request@v5
      continue-on-error: true  # Don't fail on PR title issues
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
          security
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Validate conventional commit messages
      if: github.event_name == 'pull_request'
      continue-on-error: true  # Don't fail the pipeline on commit message issues
      run: |
        python .github/scripts/ci_helpers.py info "**Conventional Commit Messages Validation**" --summary-only
        
        # Get the base branch commit
        git fetch origin ${{ github.base_ref }}
        base_commit=$(git merge-base origin/${{ github.base_ref }} HEAD)
        
        # Get all commits in this PR
        commits=$(git log --format="%H" $base_commit..HEAD)
        
        if [ -z "$commits" ]; then
          python .github/scripts/ci_helpers.py warning "No commits found to validate" --summary-only
          exit 0
        fi
        
        # Conventional commit pattern
        # Matches: type(scope): description or type: description
        # Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security
        pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security)(\(.+\))?: .+"
        
        invalid_commits=""
        valid_count=0
        total_count=0
        
        echo "Checking commits for conventional commit format..." | tee -a $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for commit in $commits; do
          total_count=$((total_count + 1))
          message=$(git log --format=%s -n 1 $commit)
          short_hash=$(git log --format=%h -n 1 $commit)
          
          if echo "$message" | grep -qE "$pattern"; then
            valid_count=$((valid_count + 1))
            echo "✅ $short_hash: $message" >> $GITHUB_STEP_SUMMARY
          else
            invalid_commits="$invalid_commits\n❌ $short_hash: $message"
            echo "❌ $short_hash: $message" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$invalid_commits" ]; then
          python .github/scripts/ci_helpers.py warning "Found $((total_count - valid_count)) commit(s) not following conventional commit format" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Conventional Commit Format:**" --summary-only
          python .github/scripts/ci_helpers.py info "\`type(scope): description\` or \`type: description\`" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Examples:**" --summary-only
          python .github/scripts/ci_helpers.py info "- \`feat(api): add new endpoint\`" --summary-only
          python .github/scripts/ci_helpers.py info "- \`fix: resolve memory leak\`" --summary-only
          python .github/scripts/ci_helpers.py info "- \`docs: update README\`" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Note:** This is a non-critical check and won't fail the pipeline" --summary-only
        else
          python .github/scripts/ci_helpers.py success "All $valid_count commit(s) follow conventional commit format" --summary-only
        fi
    
    - name: Validate commit messages for push events
      if: github.event_name == 'push'
      continue-on-error: true  # Don't fail the pipeline on commit message issues
      run: |
        python .github/scripts/ci_helpers.py info "**Conventional Commit Messages Validation (Push Event)**" --summary-only
        
        # Get the last commit message
        message=$(git log --format=%s -n 1 HEAD)
        short_hash=$(git log --format=%h -n 1 HEAD)
        
        # Conventional commit pattern
        pattern="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security)(\(.+\))?: .+"
        
        echo "Checking latest commit for conventional commit format..." | tee -a $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if echo "$message" | grep -qE "$pattern"; then
          echo "✅ $short_hash: $message" >> $GITHUB_STEP_SUMMARY
          python .github/scripts/ci_helpers.py success "Latest commit follows conventional commit format" --summary-only
        else
          echo "❌ $short_hash: $message" >> $GITHUB_STEP_SUMMARY
          python .github/scripts/ci_helpers.py warning "Latest commit does not follow conventional commit format" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Conventional Commit Format:**" --summary-only
          python .github/scripts/ci_helpers.py info "\`type(scope): description\` or \`type: description\`" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Valid types:** feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security" --summary-only
          python .github/scripts/ci_helpers.py info "" --summary-only
          python .github/scripts/ci_helpers.py info "**Note:** This is a non-critical check and won't fail the pipeline" --summary-only
        fi
    
    - name: Generate conventional commits summary
      if: always()
      run: |
        python .github/scripts/ci_helpers.py completion "**CONVENTIONAL COMMITS CHECK COMPLETED!**" --summary-only
        python .github/scripts/ci_helpers.py info "**Commit Message Quality:**" --summary-only
        python .github/scripts/ci_helpers.py info "- **Format Validation** (Conventional commits standard)" --summary-only
        python .github/scripts/ci_helpers.py info "- **Best Practices** (Semantic versioning support)" --summary-only
        python .github/scripts/ci_helpers.py warning "**Note:** This is a non-critical check - pipeline passes regardless of result" --summary-only
        python .github/scripts/ci_helpers.py info "**Conventional commits improve changelog generation and semantic versioning**"