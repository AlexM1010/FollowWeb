name: Nightly Dependency & Security Check

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # PHASE 1: PARALLEL INITIALIZATION
  environment-build:
    name: Build Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: FollowWeb
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Install dependencies and create cache
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -r requirements-ci.txt -e .
    
    - name: Verify environment
      run: |
        python -c "import FollowWeb_Visualizor; print('âœ… Package ready')"
  
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: FollowWeb
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        python -m pip install -r requirements-ci.txt -e .
    
    - name: Run quick smoke tests
      run: |
        cpu_count=$(python -c "import os; print(os.cpu_count() or 1)")
        python -m pytest -p no:benchmark -m unit -x --maxfail=1 --tb=short -v -n $cpu_count
      env:
        MPLBACKEND: Agg
  
  # PHASE 2: SECURITY AND DEPENDENCY CHECKS
  dependency-security:
    name: Dependency & Security Check
    runs-on: ubuntu-latest
    needs: [environment-build, smoke-test]
    timeout-minutes: 15
    defaults:
      run:
        working-directory: FollowWeb
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements-ci.txt -e .
    
    - name: Check for security vulnerabilities
      run: |
        echo "**Nightly Security Scan**" >> $GITHUB_STEP_SUMMARY
        echo "**pip-audit Results (Strict)**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        # FAIL on ANY vulnerabilities in nightly builds (stricter than CI)
        pip-audit --desc >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "**Bandit Results (All Severity)**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        # Check ALL severity levels (stricter than CI which only checks medium/high)
        bandit -r FollowWeb_Visualizor >> $GITHUB_STEP_SUMMARY || echo "Security issues found - review above"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Check for outdated dependencies
      run: |
        echo "**Outdated Dependencies**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        python -m pip list --outdated >> $GITHUB_STEP_SUMMARY || echo "All dependencies up to date" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
    
    - name: Test with latest dependency versions
      run: |
        echo "**Testing with Latest Dependencies**" >> $GITHUB_STEP_SUMMARY
        # Create a test environment with latest versions
        python -m venv test_latest
        source test_latest/bin/activate || test_latest\\Scripts\\activate
        
        # Install latest versions of all dependencies
        pip install --upgrade pip
        pip install -r requirements.txt --upgrade
        pip install -e .
        
        # Run a quick smoke test
        python -c "import FollowWeb_Visualizor"
        python ../ci_helpers.py success "Package imports successfully with latest dependencies"
        
        # Run core unit tests only (not full suite) - use pytest directly
        python -m pytest -m unit -x --tb=short --maxfail=5
        
        deactivate
        python ../ci_helpers.py success "Core functionality verified with latest dependencies" --summary-only
      shell: bash
      continue-on-error: true  # Don't fail nightly if latest deps break something
      env:
        MPLBACKEND: Agg

  ecosystem-compatibility:
    name: Ecosystem Compatibility Check
    runs-on: ${{ matrix.os }}
    needs: [environment-build, smoke-test]
    timeout-minutes: 20
    defaults:
      run:
        working-directory: FollowWeb
    
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        # Optimized matrix: 3 strategic builds
        include:
          - os: macos-latest
            python-version: '3.12'  # macOS latest supported
          - os: ubuntu-latest
            python-version: '3.9'   # Linux oldest supported
          - os: windows-latest
            python-version: '3.12'  # Windows stable version
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements-ci.txt -e .
    
    - name: Run core functionality tests
      run: |
        # Only run essential tests to catch ecosystem breakage - use pytest directly
        python -m pytest -m unit -k "not slow" --tb=short --maxfail=5
        python ../ci_helpers.py success "Core tests passed on ${{ matrix.os }} Python ${{ matrix.python-version }}" --summary-only
      env:
        MPLBACKEND: Agg