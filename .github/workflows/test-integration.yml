name: Integration Tests

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main, develop ]
    paths:
      - 'FollowWeb/FollowWeb_Visualizor/**'
      - 'FollowWeb/tests/integration/**'
      - '.github/workflows/**'

jobs:
  integration-tests:
    name: Integration Test Suite
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    defaults:
      run:
        working-directory: FollowWeb
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.10', '3.12']  # Test middle and latest versions
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements-ci.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements-ci.txt -e .
    
    - name: Run integration tests
      run: |
        # Run integration tests specifically
        python tests/run_tests.py integration -v --tb=short
        echo "✅ Integration tests passed on ${{ matrix.os }} Python ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
      env:
        MPLBACKEND: Agg
        PYTHONPATH: ${{ github.workspace }}/FollowWeb
    
    - name: Test end-to-end pipeline
      run: |
        # Test the complete pipeline with real data
        python -m FollowWeb_Visualizor examples/followers_following.json --config configs/fast_config.json --output-dir test_output
        
        # Verify outputs were created
        if [ -d "test_output" ]; then
          echo "✅ End-to-end pipeline completed successfully" >> $GITHUB_STEP_SUMMARY
          ls -la test_output/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "❌ End-to-end pipeline failed - no output directory created" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
      continue-on-error: false
    
    - name: Test package installation
      run: |
        # Test clean installation in isolated environment
        python -m venv test_install
        source test_install/bin/activate || test_install\\Scripts\\activate
        
        # Install from built package
        python -m build --wheel --outdir dist/
        pip install dist/*.whl
        
        # Test CLI works
        followweb --help
        
        # Test import works
        python -c "import FollowWeb_Visualizor; print('✅ Package installs and imports correctly')"
        
        deactivate
        echo "✅ Package installation test passed" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload test outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-outputs-${{ matrix.os }}-${{ matrix.python-version }}
        path: FollowWeb/test_output/
        retention-days: 7
        if-no-files-found: ignore

  cross-platform-compatibility:
    name: Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    defaults:
      run:
        working-directory: FollowWeb
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']  # Single version for compatibility testing
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt -e .
    
    - name: Test core functionality across platforms
      run: |
        # Test basic import and functionality
        python -c "
        import FollowWeb_Visualizor
        from FollowWeb_Visualizor.core.config import ConfigurationManager
        from FollowWeb_Visualizor.data.loaders import GraphLoader
        print('✅ Core imports successful on ${{ matrix.os }}')
        "
        
        # Test file operations work cross-platform
        python -c "
        from FollowWeb_Visualizor.utils.files import ensure_output_directory
        import tempfile
        import os
        test_dir = ensure_output_directory(os.path.join(tempfile.gettempdir(), 'followweb_test'))
        print(f'✅ File operations work: {test_dir}')
        "
      env:
        MPLBACKEND: Agg