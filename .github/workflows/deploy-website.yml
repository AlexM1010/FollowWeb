# Deploy Freesound Website to GitHub Pages
#
# Automatically deploys the Freesound network visualization website to GitHub Pages
# when new visualizations or metrics are committed to the repository.
#
# Triggers:
# - Push to Output/*.html (new visualizations)
# - Push to data/metrics_history.jsonl (updated metrics)
# - Push to data/milestone_history.jsonl (milestone updates)
# - Manual workflow dispatch
#
# Architecture:
# - Generates landing page with network statistics and growth charts
# - Copies visualizations to website directory
# - Deploys to gh-pages branch using peaceiris/actions-gh-pages
# - Public URL: https://<username>.github.io/<repo>/

name: Deploy Freesound Website

on:
  push:
    paths:
      - 'Output/*.html'
      - 'data/metrics_history.jsonl'
      - 'data/milestone_history.jsonl'
  workflow_dispatch:

# Permissions for GitHub Pages deployment
permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for accurate metrics
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jinja2 pandas matplotlib
    
    - name: Generate landing page
      id: generate
      env:
        PLAUSIBLE_DOMAIN: ${{ secrets.PLAUSIBLE_DOMAIN }}
      run: |
        echo "## ðŸŒ Website Generation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if generate_landing_page.py exists
        if [ ! -f "generate_landing_page.py" ]; then
          echo "âš ï¸ Landing page generator not found, creating basic index.html" >> $GITHUB_STEP_SUMMARY
          
          # Create basic website directory structure
          mkdir -p website/visualizations
          
          # Create basic index.html if generator doesn't exist
          cat > website/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freesound Network Explorer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .viz-list {
            list-style: none;
            padding: 0;
        }
        .viz-list li {
            margin: 10px 0;
        }
        .viz-list a {
            color: #0066cc;
            text-decoration: none;
            font-size: 18px;
        }
        .viz-list a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Freesound Network Explorer</h1>
        <p>Interactive visualization of Freesound sample relationships</p>
        <h2>Available Visualizations</h2>
        <ul class="viz-list" id="vizList"></ul>
    </div>
    <script>
        // Dynamically list available visualizations
        fetch('visualizations/')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .filter(a => a.href.endsWith('.html'))
                    .map(a => a.href.split('/').pop());
                
                const list = document.getElementById('vizList');
                if (links.length === 0) {
                    list.innerHTML = '<li>No visualizations available yet</li>';
                } else {
                    links.forEach(link => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `visualizations/${link}`;
                        a.textContent = link;
                        li.appendChild(a);
                        list.appendChild(li);
                    });
                }
            })
            .catch(() => {
                document.getElementById('vizList').innerHTML = '<li>Loading visualizations...</li>';
            });
    </script>
</body>
</html>
EOF
          
          echo "- âœ… Created basic index.html" >> $GITHUB_STEP_SUMMARY
        else
          # Use the landing page generator script
          # Build command with optional Plausible domain
          cmd="python generate_landing_page.py --output-dir website --metrics-history data/metrics_history.jsonl --milestone-history data/milestone_history.jsonl --visualizations Output/*.html"
          
          # Add Plausible domain if configured
          if [ -n "$PLAUSIBLE_DOMAIN" ]; then
            cmd="$cmd --plausible-domain $PLAUSIBLE_DOMAIN"
            echo "- ðŸ“ˆ Plausible Analytics enabled for: \`$PLAUSIBLE_DOMAIN\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Execute command
          eval "$cmd"
          
          echo "- âœ… Generated landing page" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Copy visualizations
      run: |
        echo "### ðŸ“Š Copying Visualizations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Create visualizations directory
        mkdir -p website/visualizations
        
        # Copy all HTML visualizations
        if ls Output/*.html 1> /dev/null 2>&1; then
          cp Output/*.html website/visualizations/
          viz_count=$(ls Output/*.html | wc -l)
          echo "- âœ… Copied $viz_count visualization(s)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ No visualizations found in Output/" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Copy library dependencies if they exist
        if [ -d "lib" ]; then
          cp -r lib website/
          echo "- âœ… Copied library dependencies" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./website
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy Freesound website: ${{ github.event.head_commit.message }}'
    
    - name: Deployment summary
      run: |
        echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Website deployed to GitHub Pages!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Public URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Note: It may take a few minutes for changes to appear." >> $GITHUB_STEP_SUMMARY
