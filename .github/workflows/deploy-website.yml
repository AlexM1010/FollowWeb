# Deploy Freesound Website to GitHub Pages
#
# Deploys the Freesound network visualization website to GitHub Pages.
# Deployment is handled by the Validation workflow after successful visualization generation.
#
# Triggers:
# - Manual workflow dispatch only
#
# Architecture:
# - Generates landing page with network statistics and growth charts
# - Copies visualizations to website directory
# - Deploys to gh-pages branch using peaceiris/actions-gh-pages
# - Public URL: https://<username>.github.io/<repo>/

name: Deploy Freesound Website

on:
  workflow_dispatch:

# Permissions for GitHub Pages deployment
permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for accurate metrics
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jinja2 pandas matplotlib
    
    - name: Generate landing page
      id: generate
      env:
        PLAUSIBLE_DOMAIN: ${{ secrets.PLAUSIBLE_DOMAIN }}
      run: |
        {
          echo "## Website Generation"
          echo ""
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Check if generate_landing_page.py exists
        if [ ! -f "generate_landing_page.py" ]; then
          echo "Landing page generator not found, using index.html if available" >> "$GITHUB_STEP_SUMMARY"
          
          # Create basic website directory structure
          mkdir -p website/visualizations
          
          # Copy existing index.html if available, otherwise skip
          if [ -f "index.html" ]; then
            cp index.html website/
            echo "- Copied existing index.html" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- No index.html found, website will only contain visualizations" >> "$GITHUB_STEP_SUMMARY"
          fi
        else
          # Use the landing page generator script
          cmd="python generate_landing_page.py --output-dir website --metrics-history data/metrics_history.jsonl --milestone-history data/milestone_history.jsonl --visualizations Output/*.html"
          
          # Add Plausible domain if configured
          if [ -n "$PLAUSIBLE_DOMAIN" ]; then
            cmd="$cmd --plausible-domain $PLAUSIBLE_DOMAIN"
            echo "- Plausible Analytics enabled for: $PLAUSIBLE_DOMAIN" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Execute command
          eval "$cmd"
          
          echo "- Generated landing page" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Copy visualizations
      run: |
        {
          echo "### ðŸ“Š Copying Visualizations"
          echo ""
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Create visualizations directory
        mkdir -p website/visualizations
        
        # Copy all HTML visualizations
        if find Output -maxdepth 1 -name "*.html" -type f | grep -q .; then
          cp Output/*.html website/visualizations/
          viz_count=$(find Output -maxdepth 1 -name "*.html" -type f | wc -l)
          echo "- âœ… Copied $viz_count visualization(s)" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âš ï¸ No visualizations found in Output/" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        # Copy library dependencies if they exist
        if [ -d "lib" ]; then
          cp -r lib website/
          echo "- âœ… Copied library dependencies" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Copy CNAME for custom domain
      run: |
        {
          echo "### ðŸŒ Configuring Custom Domain"
          echo ""
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Copy CNAME file if it exists
        if [ -f "CNAME" ]; then
          cp CNAME website/
          echo "- âœ… Copied CNAME file for custom domain: $(cat CNAME)" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âš ï¸ No CNAME file found (using default GitHub Pages URL)" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./website
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy Freesound website: ${{ github.event.head_commit.message }}'
    
    - name: Deployment summary
      run: |
        {
          echo "### âœ… Deployment Complete"
          echo ""
          echo "Website deployed to GitHub Pages!"
          echo ""
          echo "**Public URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo ""
          echo "Note: It may take a few minutes for changes to appear."
        } >> "$GITHUB_STEP_SUMMARY"
