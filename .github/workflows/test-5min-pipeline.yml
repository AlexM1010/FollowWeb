# Test 5-Minute Pipeline
#
# Quick test workflow that runs for approximately 5 minutes to verify
# the pipeline is working correctly with minimal resource usage.
#
# Features:
# - Manual trigger only
# - Limited to ~50 API requests (5 minutes runtime)
# - Shallow depth (1 level)
# - Quick validation and output generation
# - Comprehensive logging

name: Test 5-Minute Pipeline

on:
  workflow_dispatch:
    inputs:
      seed_sample_id:
        description: 'Seed sample ID (leave empty for auto-detect)'
        required: false
        default: ''
        type: string

# Prevent concurrent runs
concurrency:
  group: test-pipeline
  cancel-in-progress: true

jobs:
  test-pipeline:
    name: Quick Test Pipeline (5 min)
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Hard timeout at 10 minutes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r FollowWeb/requirements.txt
        pip install -e FollowWeb/
    
    - name: Verify installation
      run: |
        echo "## ðŸ” Environment Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python --version >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        python -c "import FollowWeb_Visualizor; print('âœ… Package imported')"
        python -c "from FollowWeb_Visualizor.data.loaders import IncrementalFreesoundLoader; print('âœ… Loader available')"
        python -c "from FollowWeb_Visualizor.visualization.renderers import SigmaRenderer; print('âœ… Renderer available')"
    
    - name: Validate secrets
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        if [ -z "$FREESOUND_API_KEY" ]; then
          echo "::error::FREESOUND_API_KEY not configured"
          exit 1
        fi
        echo "âœ… API key configured"
    
    - name: Set test parameters
      id: params
      run: |
        echo "execution_id=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
        echo "max_requests=50" >> $GITHUB_OUTPUT
        echo "depth=1" >> $GITHUB_OUTPUT
    
    - name: Display test configuration
      run: |
        echo "## ðŸ§ª Test Configuration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ github.event.inputs.seed_sample_id }}" ]; then
          echo "| Seed Sample | \`${{ github.event.inputs.seed_sample_id }}\` |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Seed Sample | \`Auto-detect (most downloaded)\` |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| Max Requests | \`${{ steps.params.outputs.max_requests }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Depth | \`${{ steps.params.outputs.depth }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Expected Runtime | \`~5 minutes\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Execution ID | \`${{ steps.params.outputs.execution_id }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Run test pipeline
      id: pipeline
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        echo "## ðŸš€ Pipeline Execution" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Starting at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Build command
        cmd="python generate_freesound_visualization.py"
        if [ -n "${{ github.event.inputs.seed_sample_id }}" ]; then
          cmd="$cmd --seed-sample-id ${{ github.event.inputs.seed_sample_id }}"
        fi
        cmd="$cmd --max-requests ${{ steps.params.outputs.max_requests }}"
        cmd="$cmd --depth ${{ steps.params.outputs.depth }}"
        
        # Run pipeline
        start_time=$(date +%s)
        eval "$cmd" 2>&1 | tee test_pipeline_${{ steps.params.outputs.execution_id }}.log
        exit_code=${PIPESTATUS[0]}
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        echo "duration=$duration" >> $GITHUB_OUTPUT
        
        if [ $exit_code -eq 0 ]; then
          echo "âœ… Pipeline completed successfully in ${duration}s"
          echo "pipeline_status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Pipeline failed with exit code: $exit_code"
          echo "pipeline_status=failed" >> $GITHUB_OUTPUT
          exit $exit_code
        fi
    
    - name: Extract statistics
      if: always()
      id: stats
      run: |
        log_file="test_pipeline_${{ steps.params.outputs.execution_id }}.log"
        
        if [ -f "$log_file" ]; then
          nodes=$(grep -oP "(?<=Total nodes: )\d+" "$log_file" | tail -1 || echo "0")
          edges=$(grep -oP "(?<=Total edges: )\d+" "$log_file" | tail -1 || echo "0")
          requests=$(grep -oP "(?<=API requests: )\d+" "$log_file" | tail -1 || echo "0")
          
          echo "nodes=$nodes" >> $GITHUB_OUTPUT
          echo "edges=$edges" >> $GITHUB_OUTPUT
          echo "requests=$requests" >> $GITHUB_OUTPUT
        else
          echo "nodes=0" >> $GITHUB_OUTPUT
          echo "edges=0" >> $GITHUB_OUTPUT
          echo "requests=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Check outputs
      if: steps.pipeline.outputs.pipeline_status == 'success'
      id: outputs
      run: |
        echo "## ðŸ“Š Output Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for HTML outputs
        html_count=$(find Output -name "*.html" -type f 2>/dev/null | wc -l)
        echo "html_files=$html_count" >> $GITHUB_OUTPUT
        
        if [ $html_count -gt 0 ]; then
          echo "### Generated Visualizations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          find Output -name "*.html" -type f -exec basename {} \; | while read file; do
            size=$(stat -f%z "Output/$file" 2>/dev/null || stat -c%s "Output/$file" 2>/dev/null || echo "unknown")
            echo "- \`$file\` (${size} bytes)" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No HTML files generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for checkpoint
        if [ -d "data/freesound_library" ]; then
          echo "### Checkpoint Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh data/freesound_library/ | tail -n +2 | while read line; do
            echo "- \`$line\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "checkpoint_exists=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ No checkpoint directory found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "checkpoint_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Generate summary
      if: always()
      run: |
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ˆ Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.pipeline.outputs.pipeline_status }}" = "success" ]; then
          echo "### âœ… Status: Success" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Status: Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Duration** | \`${{ steps.pipeline.outputs.duration }}s\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Nodes** | \`${{ steps.stats.outputs.nodes }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Edges** | \`${{ steps.stats.outputs.edges }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **API Requests** | \`${{ steps.stats.outputs.requests }}\` / \`${{ steps.params.outputs.max_requests }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **HTML Files** | \`${{ steps.outputs.outputs.html_files }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Checkpoint** | \`${{ steps.outputs.outputs.checkpoint_exists }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.pipeline.outputs.pipeline_status }}" = "success" ]; then
          echo "### âœ… All Systems Operational" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The pipeline is working correctly. You can now:" >> $GITHUB_STEP_SUMMARY
          echo "- Review the generated visualizations in the artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Check the logs for any warnings" >> $GITHUB_STEP_SUMMARY
          echo "- Run the full nightly pipeline with confidence" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the logs to identify the issue." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-pipeline-outputs-${{ steps.params.outputs.execution_id }}
        path: |
          Output/*.html
          Output/*.png
          test_pipeline_*.log
          data/freesound_library/checkpoint_metadata.json
        retention-days: 7
        if-no-files-found: warn
    
    - name: Upload full checkpoint (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-checkpoint-${{ steps.params.outputs.execution_id }}
        path: |
          data/freesound_library/
        retention-days: 7
        if-no-files-found: ignore
