name: Freesound Validation & Visualization

on:
  workflow_run:
    workflows: ["Freesound Data Repair"]
    types: [completed]
    branches: [main]
  
  workflow_dispatch:
    # Allow manual triggering for testing

# Prevent workflow collisions
concurrency:
  group: freesound-validation
  cancel-in-progress: false

# Grant write permissions for committing changes
permissions:
  contents: write

jobs:
  validate-and-visualize:
    name: Validate Data & Generate Visualization
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Only run if repair pipeline succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git config --global init.defaultBranch main
        git config --global advice.detachedHead false
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r FollowWeb/requirements.txt
        pip install -e FollowWeb/
    
    - name: Verify installation
      run: |
        python -c "import FollowWeb_Visualizor"
        echo "âœ… FollowWeb package imported successfully"
        python -c "from FollowWeb_Visualizor.data.loaders import IncrementalFreesoundLoader"
        echo "âœ… IncrementalFreesoundLoader available"
        python -c "from FollowWeb_Visualizor.visualization.renderers import SigmaRenderer"
        echo "âœ… SigmaRenderer available"
    
    - name: Set execution parameters
      id: params
      run: |
        echo "execution_id=$(date +'%Y%m%d_%H%M%S')" >> "$GITHUB_OUTPUT"
        
        # Determine cache key based on trigger
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # For manual runs, try to restore from latest cache or download from repo
          {
            echo "cache_key=checkpoint-repaired-"
            echo "use_cache=true"
            echo "allow_fallback=true"
          } >> "$GITHUB_OUTPUT"
        else
          # For triggered runs, use cache from repair pipeline
          # The repair workflow saves with its own run ID, so we use that
          {
            echo "cache_key=checkpoint-repaired-${{ github.event.workflow_run.id }}"
            echo "use_cache=true"
            echo "allow_fallback=false"
          } >> "$GITHUB_OUTPUT"
        fi

    - name: Display workflow configuration
      run: |
        {
          echo "## ðŸ” Validation & Visualization Workflow"
          echo ""
          echo "**Configuration:**"
          echo "- Execution ID: \`${{ steps.params.outputs.execution_id }}\`"
          echo "- Trigger: \`${{ github.event_name }}\`"
        } >> "$GITHUB_STEP_SUMMARY"
        if [ "${{ steps.params.outputs.use_cache }}" = "true" ]; then
          {
            echo "- Cache Key: \`${{ steps.params.outputs.cache_key }}\`"
            echo "- Upstream Run: [#${{ github.event.workflow_run.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})"
          } >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- Source: Manual run (using checkpoint from repository)" >> "$GITHUB_STEP_SUMMARY"
        fi
        echo "" >> "$GITHUB_STEP_SUMMARY"
    
    # Subtask 10.1: Restore checkpoint from cache
    - name: Restore checkpoint from cache
      if: steps.params.outputs.use_cache == 'true'
      uses: actions/cache/restore@v3
      id: cache-restore
      with:
        path: data/freesound_library
        key: ${{ steps.params.outputs.cache_key }}
        restore-keys: |
          checkpoint-repaired-
          checkpoint-
        fail-on-cache-miss: false
    
    - name: Check cache restore status
      if: steps.params.outputs.use_cache == 'true'
      id: cache-check
      run: |
        # Check if cache was actually restored by verifying directory exists
        # Note: cache-hit is false when restore-keys are used, even if cache was restored
        if [ -d "data/freesound_library" ] && [ "$(ls -A data/freesound_library 2>/dev/null)" ]; then
          echo "âœ… Cache restored successfully"
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" = "true" ]; then
            echo "  - Exact match: ${{ steps.params.outputs.cache_key }}"
          else
            echo "  - Fallback match: ${{ steps.cache-restore.outputs.cache-matched-key }}"
          fi
          echo "cache_restored=true" >> "$GITHUB_OUTPUT"
        else
          {
            echo "## âš ï¸  Cache Restore Failed"
            echo ""
            echo "**Cache Key:** \`${{ steps.params.outputs.cache_key }}\`"
            echo ""
            echo "**Attempting fallback to repository download...**"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "cache_restored=false" >> "$GITHUB_OUTPUT"
        fi


    
    - name: Verify checkpoint files
      run: |
        echo "Verifying checkpoint files..."
        
        if [ "${{ steps.params.outputs.use_cache }}" = "true" ]; then
          # Check if cache was restored
          if [ ! -d "data/freesound_library" ]; then
            echo "âŒ Cache restore failed - checkpoint directory not found"
            exit 1
          fi
        fi
        
        # Check required files exist
        CHECKPOINT_DIR="data/freesound_library"
        
        {
          echo ""
          echo "**Checkpoint Files:**"
          echo ""
        } >> "$GITHUB_STEP_SUMMARY"
        
        missing_files=0
        
        # Verify graph_topology.gpickle
        if [ ! -f "$CHECKPOINT_DIR/graph_topology.gpickle" ]; then
          echo "âŒ Missing graph_topology.gpickle"
          echo "- âŒ Missing: graph_topology.gpickle" >> "$GITHUB_STEP_SUMMARY"
          missing_files=$((missing_files + 1))
        else
          graph_size=$(stat -f%z "$CHECKPOINT_DIR/graph_topology.gpickle" 2>/dev/null || stat -c%s "$CHECKPOINT_DIR/graph_topology.gpickle")
          if [ "$graph_size" -lt 1024 ]; then
            echo "âŒ graph_topology.gpickle too small: $graph_size bytes"
            echo "- âŒ graph_topology.gpickle: Too small ($graph_size bytes)" >> "$GITHUB_STEP_SUMMARY"
            missing_files=$((missing_files + 1))
          else
            echo "âœ… graph_topology.gpickle: $(numfmt --to=iec-i --suffix=B "$graph_size")"
            echo "- âœ… graph_topology.gpickle: \`$(numfmt --to=iec-i --suffix=B "$graph_size")\`" >> "$GITHUB_STEP_SUMMARY"
          fi
        fi
        
        # Verify metadata_cache.db
        if [ ! -f "$CHECKPOINT_DIR/metadata_cache.db" ]; then
          echo "âŒ Missing metadata_cache.db"
          echo "- âŒ Missing: metadata_cache.db" >> "$GITHUB_STEP_SUMMARY"
          missing_files=$((missing_files + 1))
        else
          db_size=$(stat -f%z "$CHECKPOINT_DIR/metadata_cache.db" 2>/dev/null || stat -c%s "$CHECKPOINT_DIR/metadata_cache.db")
          if [ "$db_size" -lt 10240 ]; then
            echo "âŒ metadata_cache.db too small: $db_size bytes"
            echo "- âŒ metadata_cache.db: Too small ($db_size bytes)" >> "$GITHUB_STEP_SUMMARY"
            missing_files=$((missing_files + 1))
          else
            echo "âœ… metadata_cache.db: $(numfmt --to=iec-i --suffix=B "$db_size")"
            echo "- âœ… metadata_cache.db: \`$(numfmt --to=iec-i --suffix=B "$db_size")\`" >> "$GITHUB_STEP_SUMMARY"
          fi
        fi
        
        # Verify checkpoint_metadata.json
        if [ ! -f "$CHECKPOINT_DIR/checkpoint_metadata.json" ]; then
          echo "âŒ Missing checkpoint_metadata.json"
          echo "- âŒ Missing: checkpoint_metadata.json" >> "$GITHUB_STEP_SUMMARY"
          missing_files=$((missing_files + 1))
        else
          meta_size=$(stat -f%z "$CHECKPOINT_DIR/checkpoint_metadata.json" 2>/dev/null || stat -c%s "$CHECKPOINT_DIR/checkpoint_metadata.json")
          if [ "$meta_size" -lt 100 ]; then
            echo "âŒ checkpoint_metadata.json too small: $meta_size bytes"
            echo "- âŒ checkpoint_metadata.json: Too small ($meta_size bytes)" >> "$GITHUB_STEP_SUMMARY"
            missing_files=$((missing_files + 1))
          else
            echo "âœ… checkpoint_metadata.json: $(numfmt --to=iec-i --suffix=B "$meta_size")"
            echo "- âœ… checkpoint_metadata.json: \`$(numfmt --to=iec-i --suffix=B "$meta_size")\`" >> "$GITHUB_STEP_SUMMARY"
          fi
        fi
        
        if [ "$missing_files" -gt 0 ]; then
          {
            echo ""
            echo "âŒ **Checkpoint verification failed: $missing_files files missing or invalid**"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi
        
        echo ""
        echo "âœ… All checkpoint files present and valid"
        echo "" >> "$GITHUB_STEP_SUMMARY"
    
    # Subtask 10.2: Validate checkpoint integrity
    - name: Validate checkpoint integrity
      id: validation
      continue-on-error: true
      run: |
        echo "Running checkpoint validation..."
        echo ""
        
        # Run validation script directly (don't capture output)
        if python scripts/validation/validate_checkpoint.py data/freesound_library; then
          echo ""
          echo "âœ… Validation passed"
          echo "validation_passed=true" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "**Validation Results:**"
            echo "âœ… Validation passed"
          } >> "$GITHUB_STEP_SUMMARY"
        else
          echo ""
          echo "âŒ Validation failed (see output above)"
          echo "validation_passed=false" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "**Validation Results:**"
            echo "âŒ Validation failed (see output above)"
            echo ""
            echo "âš ï¸  **Skipping visualization and deployment due to validation failure**"
            echo "âš ï¸  **Backup workflow will NOT be triggered**"
            echo ""
            echo "**Next Steps:**"
            echo "1. Review validation errors above"
            echo "2. Check data repair workflow logs"
            echo "3. Manually trigger repair workflow if needed"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

    # Subtask 10.3: Generate edges from existing data
    - name: Generate edges (zero API requests)
      if: steps.validation.outputs.validation_passed == 'true'
      id: edge-generation
      run: |
        echo "Generating edges from existing checkpoint data..."
        {
          echo ""
          echo "**Edge Generation:**"
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Generate edges and save statistics
        python scripts/generation/generate_edges.py \
          --checkpoint-dir data/freesound_library \
          --user-edges \
          --pack-edges \
          --tag-edges \
          --tag-threshold 0.3 \
          --output edge_stats.json
        
        # Display edge statistics
        if [ -f edge_stats.json ]; then
          {
            echo "\`\`\`json"
            cat edge_stats.json
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
          
          # Extract counts for output
          USER_EDGES=$(jq -r '.user_edges_added // 0' edge_stats.json)
          PACK_EDGES=$(jq -r '.pack_edges_added // 0' edge_stats.json)
          TAG_EDGES=$(jq -r '.tag_edges_added // 0' edge_stats.json)
          
          {
            echo "user_edges=$USER_EDGES"
            echo "pack_edges=$PACK_EDGES"
            echo "tag_edges=$TAG_EDGES"
          } >> "$GITHUB_OUTPUT"
          
          echo "âœ… Generated $USER_EDGES user edges, $PACK_EDGES pack edges, $TAG_EDGES tag edges"
        else
          echo "âš ï¸  Edge statistics file not found"
        fi

    # Subtask 10.4: Generate visualization
    - name: Generate Sigma.js visualization
      if: steps.validation.outputs.validation_passed == 'true'
      id: visualization
      continue-on-error: true
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        echo "Generating Sigma.js visualization..."
        {
          echo ""
          echo "**Visualization:**"
        } >> "$GITHUB_STEP_SUMMARY"
        
        # Generate visualization from checkpoint with verbose output
        echo "Generating visualization from checkpoint..."
        
        # Run with explicit error capture
        set +e  # Don't exit on error
        python scripts/visualization/visualize_checkpoint.py \
          --checkpoint-dir data/freesound_library \
          --renderer-type sigma \
          --output-dir Output 2>&1 | tee visualization.log
        VIZ_EXIT_CODE=${PIPESTATUS[0]}
        set -e  # Re-enable exit on error
        
        if [ "$VIZ_EXIT_CODE" -eq 0 ]; then
          echo "visualization_generated=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Visualization generated successfully" >> "$GITHUB_STEP_SUMMARY"
        else
          {
            echo "visualization_generated=false"
            echo "âŒ Visualization generation failed (exit code: $VIZ_EXIT_CODE)"
            echo ""
            echo "**Error Log:**"
            echo "\`\`\`"
            tail -n 50 visualization.log || echo "No log available"
            echo "\`\`\`"
            echo ""
            echo "âš ï¸  **Previous visualization remains live on GitHub Pages**"
            echo "âš ï¸  **Backup workflow will NOT be triggered**"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "visualization_generated=false" >> "$GITHUB_OUTPUT"
          echo "âŒ Visualization generation failed with exit code: $VIZ_EXIT_CODE"
          cat visualization.log
          exit 1
        fi
        
        # Find generated visualization
        echo "Checking for generated visualization files..."
        ls -lah Output/ || echo "Output directory is empty or doesn't exist"
        
        VIZ_FILE=$(find Output -maxdepth 1 -name "freesound_*.html" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -n1 | cut -d' ' -f2-)
        
        if [ -n "$VIZ_FILE" ] && [ -f "$VIZ_FILE" ]; then
          {
            echo "visualization_generated=true"
            echo "visualization_file=$VIZ_FILE"
          } >> "$GITHUB_OUTPUT"
          echo "âœ… Visualization generated: \`$VIZ_FILE\`" >> "$GITHUB_STEP_SUMMARY"
          
          # Get file size
          VIZ_SIZE=$(du -h "$VIZ_FILE" | cut -f1)
          echo "- File size: $VIZ_SIZE" >> "$GITHUB_STEP_SUMMARY"
          
          # Verify file is not empty
          FILE_SIZE_BYTES=$(stat -c%s "$VIZ_FILE")
          if [ "$FILE_SIZE_BYTES" -lt 1024 ]; then
            {
              echo "visualization_generated=false"
              echo "âŒ Visualization file is too small ($FILE_SIZE_BYTES bytes)"
              echo ""
              echo "âš ï¸  **Previous visualization remains live on GitHub Pages**"
              echo "âš ï¸  **Backup workflow will NOT be triggered**"
            } >> "$GITHUB_STEP_SUMMARY"
            echo "visualization_generated=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
        else
          {
            echo "visualization_generated=false"
            echo "âŒ Visualization file not found in Output directory"
            echo ""
            echo "**Output directory contents:**"
            echo "\`\`\`"
            ls -lah Output/ 2>&1 || echo "Directory doesn't exist"
            echo "\`\`\`"
            echo ""
            echo "âš ï¸  **Previous visualization remains live on GitHub Pages**"
            echo "âš ï¸  **Backup workflow will NOT be triggered**"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "visualization_generated=false" >> "$GITHUB_OUTPUT"
          exit 1
        fi

    # Subtask 10.5: Deploy to GitHub Pages
    - name: Update landing page
      if: steps.validation.outputs.validation_passed == 'true' && steps.visualization.outputs.visualization_generated == 'true'
      id: landing-page
      continue-on-error: true
      run: |
        echo "Updating landing page..."
        
        # Generate landing page with latest visualization and capture output
        LANDING_OUTPUT=$(python generate_landing_page.py \
          --output-dir . \
          --visualizations "Output/*.html" \
          --plausible-domain "alexm1010.github.io" 2>&1)
        LANDING_EXIT_CODE=$?
        
        if [ "$LANDING_EXIT_CODE" -ne 0 ]; then
          {
            echo "landing_page_updated=false"
            echo "âŒ Landing page update failed"
            echo ""
            echo "**Error Details:**"
            echo "\`\`\`"
            echo "$LANDING_OUTPUT"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "landing_page_updated=false" >> "$GITHUB_OUTPUT"
          exit 1
        fi
        
        echo "landing_page_updated=true" >> "$GITHUB_OUTPUT"
        echo "âœ… Landing page updated"
    
    # Commit visualization and landing page to gh-pages branch
    - name: Commit visualization to gh-pages branch
      if: steps.validation.outputs.validation_passed == 'true' && steps.visualization.outputs.visualization_generated == 'true' && steps.landing-page.outputs.landing_page_updated == 'true'
      id: deployment
      run: |
        # Check if there are changes to commit
        if git diff --quiet Output/ index.html; then
          echo "No changes to commit"
          echo "deployment_successful=true" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "**Deployment Status:**"
            echo "- â„¹ï¸  No changes detected"
            echo "- â­ï¸  Pages workflow will deploy existing files"
          } >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Switching to gh-pages branch..."
          
          # Stash any changes in main branch before switching
          git add Output/ index.html
          git stash push -m "Stash visualization files before gh-pages switch"
          
          # Fetch and checkout gh-pages
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          git checkout gh-pages || git checkout --orphan gh-pages
          
          # Clear gh-pages and restore files from stash
          git rm -rf . 2>/dev/null || true
          git stash pop || git checkout stash@{0} -- Output/ index.html
          
          git add Output/ index.html
          git commit -m "ðŸŽ¨ Update visualization from validation pipeline
          
          Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin gh-pages; then
              echo "âœ… Push successful"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸  Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 2
                git pull --rebase origin gh-pages || git pull --no-rebase origin gh-pages
              else
                echo "âŒ Push failed after $MAX_RETRIES attempts"
                echo "deployment_successful=false" >> "$GITHUB_OUTPUT"
                {
                  echo ""
                  echo "**Deployment Status:**"
                  echo "- âŒ Failed to push changes after $MAX_RETRIES attempts"
                  echo "- âš ï¸  Git conflict or concurrent workflow detected"
                } >> "$GITHUB_STEP_SUMMARY"
                exit 1
              fi
            fi
          done
          
          echo "deployment_successful=true" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "**Deployment Status:**"
            echo "- âœ… Visualization committed to gh-pages branch"
            echo "- â­ï¸  Pages workflow will deploy from gh-pages"
            echo "- ðŸ’¾ Backup workflow will persist to storage"
          } >> "$GITHUB_STEP_SUMMARY"
        fi
    
    # Save checkpoint to cache for downstream workflows
    - name: Save to cache for Pages and Backup workflows
      if: steps.validation.outputs.validation_passed == 'true' && steps.visualization.outputs.visualization_generated == 'true' && steps.deployment.outputs.deployment_successful == 'true'
      uses: actions/cache/save@v3
      with:
        path: data/freesound_library
        key: checkpoint-${{ github.run_id }}
    
    - name: Check workflow success
      if: always()
      run: |
        # This step ensures the workflow fails if validation, visualization, or deployment failed
        # This prevents the backup workflow from being triggered on failure
        
        if [ "${{ steps.validation.outputs.validation_passed }}" != "true" ]; then
          echo "âŒ Workflow failed: Validation did not pass"
          exit 1
        fi
        
        if [ "${{ steps.visualization.outputs.visualization_generated }}" != "true" ]; then
          echo "âŒ Workflow failed: Visualization was not generated"
          exit 1
        fi
        
        if [ "${{ steps.deployment.outputs.deployment_successful }}" != "true" ]; then
          echo "âŒ Workflow failed: Deployment was not successful"
          exit 1
        fi
        
        echo "âœ… All critical steps completed successfully"
    
    - name: Generate workflow summary
      if: always()
      run: |
        {
          echo ""
          echo "---"
          echo ""
          echo "**Workflow Results:**"
          
          # Validation status
          if [ "${{ steps.validation.outputs.validation_passed }}" = "true" ]; then
            echo "- âœ… Validation: Passed"
          else
            echo "- âŒ Validation: Failed"
          fi
          
          # Edge generation status
          if [ -n "${{ steps.edge-generation.outputs.user_edges }}" ]; then
            echo "- âœ… Edge Generation: Complete"
            echo "  - User edges: ${{ steps.edge-generation.outputs.user_edges }}"
            echo "  - Pack edges: ${{ steps.edge-generation.outputs.pack_edges }}"
            echo "  - Tag edges: ${{ steps.edge-generation.outputs.tag_edges }}"
          elif [ "${{ steps.validation.outputs.validation_passed }}" = "true" ]; then
            echo "- âš ï¸  Edge Generation: Skipped or failed"
          else
            echo "- â­ï¸  Edge Generation: Skipped (validation failed)"
          fi
          
          # Visualization status
          if [ "${{ steps.visualization.outputs.visualization_generated }}" = "true" ]; then
            echo "- âœ… Visualization: Generated"
          elif [ "${{ steps.validation.outputs.validation_passed }}" = "true" ]; then
            echo "- âŒ Visualization: Failed"
          else
            echo "- â­ï¸  Visualization: Skipped (validation failed)"
          fi
          
          # Deployment status
          if [ "${{ steps.deployment.outputs.deployment_successful }}" = "true" ]; then
            echo "- âœ… Deployment: Complete"
          elif [ "${{ steps.visualization.outputs.visualization_generated }}" = "true" ]; then
            echo "- âŒ Deployment: Failed"
          else
            echo "- â­ï¸  Deployment: Skipped (visualization failed or validation failed)"
          fi
          
          echo ""
          echo "**Next Steps:**"
          
          # Determine if backup workflow should be triggered
          WORKFLOW_SUCCESS="false"
          if [ "${{ steps.validation.outputs.validation_passed }}" = "true" ] && \
             [ "${{ steps.visualization.outputs.visualization_generated }}" = "true" ] && \
             [ "${{ steps.deployment.outputs.deployment_successful }}" = "true" ]; then
            WORKFLOW_SUCCESS="true"
          fi
          
          if [ "$WORKFLOW_SUCCESS" = "true" ]; then
            echo "- âœ… Backup workflow will be triggered automatically"
            echo "- âœ… All pipeline stages completed successfully"
          else
            echo "- âš ï¸  **Backup workflow will NOT be triggered**"
            echo "- âš ï¸  **Previous visualization remains live on GitHub Pages**"
            echo ""
            echo "**Failure Reason:**"
            if [ "${{ steps.validation.outputs.validation_passed }}" != "true" ]; then
              echo "- Validation failed - check validation errors above"
            elif [ "${{ steps.visualization.outputs.visualization_generated }}" != "true" ]; then
              echo "- Visualization generation failed - check visualization errors above"
            elif [ "${{ steps.deployment.outputs.deployment_successful }}" != "true" ]; then
              echo "- Deployment failed - check deployment errors above"
            fi
            echo ""
            echo "**Recovery Actions:**"
            echo "1. Review error details in the failed step above"
            echo "2. Check data repair workflow logs if validation failed"
            echo "3. Manually trigger repair workflow if needed"
            echo "4. Manually trigger this workflow again after fixes"
          fi
        } >> "$GITHUB_STEP_SUMMARY"

# Note: Subtask 10.6 - Backup workflow trigger
# The backup workflow (freesound-backup.yml) is configured with:
#   on:
#     workflow_run:
#       workflows: ["Freesound Validation & Visualization"]
#       types: [completed]
#       branches: [main]
# AND a job-level condition that checks:
#   github.event.workflow_run.conclusion == 'success'
# This ensures the backup workflow only runs when this validation workflow
# completes successfully. If validation, visualization, or deployment fails,
# the backup workflow will NOT run, preserving the previous valid backup.
