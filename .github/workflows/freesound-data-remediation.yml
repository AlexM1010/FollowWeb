# Freesound Data Remediation Workflow
#
# This workflow remediates incomplete or inconsistent data in the Freesound checkpoint:
# - Regenerates missing checkpoint metadata
# - Adds missing user/pack edges
# - Validates and fixes data integrity issues
# - Updates metadata cache from graph data
#
# Features:
# - Manual trigger only (run when data issues detected)
# - Comprehensive data validation
# - Automatic remediation of common issues
# - Detailed reporting of fixes applied
# - Safe operation (creates backup before changes)

name: Freesound Data Remediation

on:
  workflow_dispatch:
    inputs:
      fix_metadata:
        description: 'Regenerate missing checkpoint metadata'
        required: false
        default: 'true'
        type: boolean
      fix_edges:
        description: 'Add missing user/pack edges'
        required: false
        default: 'true'
        type: boolean
      fix_cache:
        description: 'Rebuild metadata cache from graph'
        required: false
        default: 'true'
        type: boolean
      validate_only:
        description: 'Only validate, do not fix (dry run)'
        required: false
        default: 'false'
        type: boolean

# Prevent concurrent runs
concurrency:
  group: freesound-remediation
  cancel-in-progress: false

jobs:
  remediate:
    name: Data Remediation
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'FollowWeb/requirements.txt'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r FollowWeb/requirements.txt
        pip install -e FollowWeb/
    
    - name: Validate secrets
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
        BACKUP_PAT: ${{ secrets.BACKUP_PAT }}
      run: |
        echo "## ðŸ”§ Data Remediation" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ -z "$FREESOUND_API_KEY" ]; then
          echo "::error::FREESOUND_API_KEY not configured"
          exit 1
        fi
        
        if [ -z "$BACKUP_PAT" ]; then
          echo "::warning::BACKUP_PAT not configured - cannot download checkpoint"
        fi
    
    - name: Download checkpoint from backup
      id: download
      env:
        BACKUP_PAT: ${{ secrets.BACKUP_PAT }}
      run: |
        echo "### ðŸ“¥ Phase 1: Download Checkpoint" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ -z "$BACKUP_PAT" ]; then
          echo "âš ï¸ No BACKUP_PAT - using local checkpoint if available" >> "$GITHUB_STEP_SUMMARY"
          echo "checkpoint_downloaded=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        
        REPO_OWNER="${{ github.repository_owner }}"
        BACKUP_REPO="${REPO_OWNER}/freesound-backup"
        
        # Get latest checkpoint
        ASSETS_JSON=$(curl -s -H "Authorization: token $BACKUP_PAT" \
          "https://api.github.com/repos/${BACKUP_REPO}/releases/tags/v-checkpoint")
        
        if echo "$ASSETS_JSON" | grep -q "Not Found"; then
          echo "âš ï¸ No backup repository found" >> "$GITHUB_STEP_SUMMARY"
          echo "checkpoint_downloaded=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        
        LATEST_ASSET=$(echo "$ASSETS_JSON" | jq -r '.assets | sort_by(.created_at) | reverse | .[0]')
        
        if [ "$LATEST_ASSET" = "null" ]; then
          echo "âš ï¸ No checkpoint backups found" >> "$GITHUB_STEP_SUMMARY"
          echo "checkpoint_downloaded=false" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        
        ASSET_URL=$(echo "$LATEST_ASSET" | jq -r '.url')
        ASSET_NAME=$(echo "$LATEST_ASSET" | jq -r '.name')
        
        echo "Downloading: $ASSET_NAME"
        curl -L -H "Authorization: token $BACKUP_PAT" \
          -H "Accept: application/octet-stream" \
          "$ASSET_URL" -o checkpoint_backup.tar.gz
        
        mkdir -p data/freesound_library
        tar -xzf checkpoint_backup.tar.gz -C data/
        rm checkpoint_backup.tar.gz
        
        echo "- âœ… Downloaded: \`$ASSET_NAME\`" >> "$GITHUB_STEP_SUMMARY"
        echo "checkpoint_downloaded=true" >> "$GITHUB_OUTPUT"
    
    - name: Validate checkpoint integrity
      id: validate
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ” Phase 2: Validate Data Integrity" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ ! -d "data/freesound_library" ]; then
          echo "::error::No checkpoint directory found"
          echo "- âŒ No checkpoint to remediate" >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi
        
        # Check for required files
        has_graph=false
        has_metadata=false
        has_cache=false
        
        if [ -f "data/freesound_library/graph_topology.gpickle" ]; then
          has_graph=true
          echo "- âœ… Graph topology file exists" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âŒ Graph topology file missing" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ -f "data/freesound_library/checkpoint_metadata.json" ]; then
          has_metadata=true
          echo "- âœ… Checkpoint metadata exists" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âš ï¸ Checkpoint metadata missing (will regenerate)" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ -f "data/freesound_library/metadata_cache.db" ]; then
          has_cache=true
          echo "- âœ… Metadata cache exists" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âš ï¸ Metadata cache missing (will regenerate)" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "has_graph=$has_graph" >> "$GITHUB_OUTPUT"
        echo "has_metadata=$has_metadata" >> "$GITHUB_OUTPUT"
        echo "has_cache=$has_cache" >> "$GITHUB_OUTPUT"
        
        if [ "$has_graph" = "false" ]; then
          echo "::error::Cannot remediate without graph topology file"
          exit 1
        fi
    
    - name: Create backup before remediation
      if: github.event.inputs.validate_only != 'true'
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ’¾ Phase 3: Create Safety Backup" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        timestamp=$(date +'%Y%m%d_%H%M%S')
        backup_file="checkpoint_before_remediation_${timestamp}.tar.gz"
        
        tar -czf "$backup_file" -C data freesound_library/
        
        size=$(stat -c%s "$backup_file" 2>/dev/null || stat -f%z "$backup_file" 2>/dev/null)
        echo "- âœ… Backup created: \`$backup_file\` ($(numfmt --to=iec-i --suffix=B $size))" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Regenerate checkpoint metadata
      if: github.event.inputs.fix_metadata == 'true' && steps.validate.outputs.has_metadata == 'false'
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ”§ Phase 4a: Regenerate Checkpoint Metadata" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ "${{ github.event.inputs.validate_only }}" = "true" ]; then
          echo "- ðŸ” Dry run: Would regenerate checkpoint metadata" >> "$GITHUB_STEP_SUMMARY"
        else
          python3 .github/scripts/regenerate_checkpoint_metadata.py
          echo "- âœ… Checkpoint metadata regenerated" >> "$GITHUB_STEP_SUMMARY"
        fi
    
    - name: Add missing user/pack edges
      if: github.event.inputs.fix_edges == 'true'
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ”§ Phase 4b: Add Missing Edges" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ "${{ github.event.inputs.validate_only }}" = "true" ]; then
          echo "- ðŸ” Dry run: Would add missing user/pack edges" >> "$GITHUB_STEP_SUMMARY"
        else
          python generate_user_pack_edges.py \
            --checkpoint-dir data/freesound_library \
            --output edge_remediation_stats.json 2>&1 | tee edge_remediation.log || true
          
          if [ -f edge_remediation_stats.json ]; then
            user_edges=$(jq -r '.user_edges_added // 0' edge_remediation_stats.json)
            pack_edges=$(jq -r '.pack_edges_added // 0' edge_remediation_stats.json)
            echo "- âœ… Added $user_edges user edges, $pack_edges pack edges" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- âš ï¸ Edge generation completed with warnings" >> "$GITHUB_STEP_SUMMARY"
          fi
        fi
    
    - name: Rebuild metadata cache
      if: github.event.inputs.fix_cache == 'true' && steps.validate.outputs.has_cache == 'false'
      env:
        FREESOUND_API_KEY: ${{ secrets.FREESOUND_API_KEY }}
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ”§ Phase 4c: Rebuild Metadata Cache" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ "${{ github.event.inputs.validate_only }}" = "true" ]; then
          echo "- ðŸ” Dry run: Would rebuild metadata cache from graph" >> "$GITHUB_STEP_SUMMARY"
        else
          python3 .github/scripts/rebuild_metadata_cache.py
          echo "- âœ… Metadata cache rebuilt from graph data" >> "$GITHUB_STEP_SUMMARY"
        fi
    
    - name: Validate remediation
      if: github.event.inputs.validate_only != 'true'
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### âœ… Phase 5: Validation" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        # Check all files exist now
        all_good=true
        
        if [ ! -f "data/freesound_library/checkpoint_metadata.json" ]; then
          echo "- âŒ Checkpoint metadata still missing" >> "$GITHUB_STEP_SUMMARY"
          all_good=false
        else
          nodes=$(jq -r '.total_nodes' data/freesound_library/checkpoint_metadata.json)
          echo "- âœ… Checkpoint metadata: $nodes nodes" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ ! -f "data/freesound_library/metadata_cache.db" ]; then
          echo "- âš ï¸ Metadata cache still missing" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- âœ… Metadata cache exists" >> "$GITHUB_STEP_SUMMARY"
        fi
        
        if [ "$all_good" = "false" ]; then
          echo "::error::Remediation incomplete"
          exit 1
        fi
    
    - name: Commit changes
      if: github.event.inputs.validate_only != 'true'
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ’¾ Phase 6: Commit Changes" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        git add data/freesound_library/
        
        if git diff --staged --quiet; then
          echo "- â„¹ï¸ No changes to commit" >> "$GITHUB_STEP_SUMMARY"
        else
          git commit -m "Data remediation: Fix incomplete checkpoint data"
          git push
          echo "- âœ… Changes committed and pushed" >> "$GITHUB_STEP_SUMMARY"
        fi
    
    - name: Generate summary
      if: always()
      run: |
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "---" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "## ðŸ“Š Remediation Summary" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ "${{ github.event.inputs.validate_only }}" = "true" ]; then
          echo "### ðŸ” Dry Run Mode" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "No changes were made. Review the validation results above." >> "$GITHUB_STEP_SUMMARY"
        else
          echo "### âœ… Remediation Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Data integrity issues have been fixed." >> "$GITHUB_STEP_SUMMARY"
        fi
        
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "**Actions Performed:**" >> "$GITHUB_STEP_SUMMARY"
        echo "- Fix Metadata: \`${{ github.event.inputs.fix_metadata }}\`" >> "$GITHUB_STEP_SUMMARY"
        echo "- Fix Edges: \`${{ github.event.inputs.fix_edges }}\`" >> "$GITHUB_STEP_SUMMARY"
        echo "- Fix Cache: \`${{ github.event.inputs.fix_cache }}\`" >> "$GITHUB_STEP_SUMMARY"
        echo "- Validate Only: \`${{ github.event.inputs.validate_only }}\`" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: remediation-artifacts
        path: |
          edge_remediation_stats.json
          edge_remediation.log
          checkpoint_before_remediation_*.tar.gz
        retention-days: 30
        if-no-files-found: ignore
